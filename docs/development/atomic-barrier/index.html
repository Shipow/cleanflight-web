<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Atomic Barrier &middot; Cleanflight
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/css/bootstrap.min.css">
  <!-- build:css /assets/stylesheets/style.min.css -->
  <link rel="stylesheet" href="http://localhost:3000/assets/stylesheets/style.css">
  <!-- endbuild -->
  <link href='//fonts.googleapis.com/css?family=Marvel:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.css">

  <!-- JS -->
  <!-- build:js /assets/javascript/all.min.js -->
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script src="//cdn.jsdelivr.net/typeahead.js/0.10.5/typeahead.jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/algoliasearch/3.5.0/algoliasearch.min.js"></script>
  <script src="http://localhost:3000/assets/javascript/javascript.js"></script>
    <script>
    window.baseUrl = 'http://localhost:3000';
    window.algolia = algoliasearch('T2ZX9HO66V', '7119d2f6f1cd95224251ec2e490e824f');
    window.index = algolia.initIndex('dev_cleanflight');
  </script>
  <!-- endbuild -->

  <!-- Icons -->
  <link rel="shortcut icon" href="http://localhost:3000/assets/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <body>
    <nav class="navbar navbar-inverse">
      <div class="container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="http://localhost:3000/"><img src="http://localhost:3000/assets/images/cleanflight-logo.png" height="50"></a>
        </div>
        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="http://localhost:3000/docs/getting-started/">Get Started</a></li>
            <li><a href="http://localhost:3000/categories/docs">Documentation</a></li>
            <!-- <li><a href="#">Ressources</a></li> -->
            <li><a href="https://github.com/cleanflight/cleanflight">Contributing</a></li>
          </ul>
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
              <input id="search" type="text" class="form-control" placeholder="Search">
            </div>
          </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <div class="container post">

  <div class="row post-full">
    <div class="col-md-9">
      <div class="content">
        <h1>Atomic Barrier Warning</h1>

<p>If GCC is upgraded and a warning appears when compiling then the generated asm source must be verified.</p>

<p>e.g.<br>
<code>
%% serial_softserial.c
warning &quot;Please verify that ATOMIC_BARRIER works as intended&quot;
</code></p>

<p>To perform the verification, proceed as per discusson on issue #167 which reads:</p>

<p>I hope it&rsquo;s enough to check that optimized-away variable still has cleanup code at end of scope.</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">static int markme=0;
markme++;
ATOMIC_BLOCK_NB(0xff) {
   ATOMIC_BARRIER(markme);
   markme++;
};
markme++;
</code></pre></div>
<p>pass <code>-save-temps=obj</code> (or <code>-save-temps=cwd</code>, but lots of files will end up in same directory as makefile) to gcc link step (LTO is in use), find resulting <code>*.ltrans*.ltrans.s</code> (grep for <code>markme</code>, on linux it ends up in <code>/tmp</code>) and check that generated assembly sequence is:</p>
<div class="highlight"><pre><code class="language-text" data-lang="text">                 MSR basepri_max, r3
# (possibly markme address load)
                # barier (markme) start

# (increment markme, load and store to memory)
        ldr     r2, [r3]
        adds    r0, r2, #1
        str     r0, [r3]

                # barier(markme)  end
                MSR basepri, r3

# (markme value should be cached in register on next increment)
</code></pre></div>
<p>The # barrier(markme) must surround access code and must be inside MSR basepri instructions ..</p>

<p>Similar approach is used for ATOMIC_BLOCK in avr libraries, so gcc should not break this behavior.</p>

<p>IMO attribute(cleanup) and asm volatile is defined in a way that should guarantee this.</p>

<p>attribute(cleanup) is probably safer way to implement atomic sections - another possibility is to explicitly place barriers in code, but that can (and will eventually) lead to missed barrier/basepri restore on same path creating very hard to find bug.</p>

<p>The MEMORY_BARRIER() code can be omitted and use ATOMIC_BLOCK with full memory barriers, but IMO it is better to explicitly state what memory is protected by barrier and gcc can use this knowledge to greatly improve generated code in future.</p>

      </div>
    </div>
    <div class="col-md-3">
      <div class="spacer30"></div>
      <h2>Documentation</h2>
      <ul class="posts list-unstyled">
        
        
          
            <li><a href="http://localhost:3000//docs/1wire">1wire</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/autotune">Autotune</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/battery">Battery</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/blackbox">Blackbox</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/board---alienwii32">Board   Alienwii32</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---cc3d">Board   Cc3d</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---chebuzzf3">Board   Chebuzzf3</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---cjmcu">Board   Cjmcu</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---colibrirace">Board   Colibrirace</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---motolab">Board   Motolab</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---naze32">Board   Naze32</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---olimexino">Board   Olimexino</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---paris-air-hero-32">Board   Paris Air Hero 32</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---rmdo">Board   Rmdo</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---sparky">Board   Sparky</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/board---spracingf3">Board   Spracingf3</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/boards">Boards</a></li>
          
        
          
        
          
        
          
        
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/buzzer">Buzzer</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/cli">Cli</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/configuration">Configuration</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/controls">Controls</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/display">Display</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/failsafe">Failsafe</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/getting-started">Getting Started</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/gps">Gps</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/gtune">Gtune</a></li>
          
        
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/inflight-adjustments">Inflight Adjustments</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/installation">Installation</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/introduction">Introduction</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/ledstrip">Ledstrip</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/migrating-from-baseflight">Migrating From Baseflight</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/mixer">Mixer</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/modes">Modes</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/oneshot">Oneshot</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/pid-tuning">Pid Tuning</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/profiles">Profiles</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/rssi">Rssi</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/rx">Rx</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/safety">Safety</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/serial">Serial</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/sonar">Sonar</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/spektrum-bind">Spektrum Bind</a></li>
          
        
          
            <li><a href="http://localhost:3000//docs/telemetry">Telemetry</a></li>
          
        
          
        
          
            <li><a href="http://localhost:3000//docs/usb-flashing">Usb Flashing</a></li>
          
        
      </ul>
      
        <div class="catbloc" id="docs">
          
          
        </div>
      
        <div class="catbloc" id="development">
          
          
            <h3>development</h3>
            <ul class="posts list-unstyled">
              
                
                  
                
              
                
                  
                    <li>
                      <a href="/docs/development/travis">
                        Travis
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/pid-internals">
                        Pid Internals
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/hardware-debugging-in-eclipse">
                        Hardware Debugging In Eclipse
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/hardware-debugging">
                        Hardware Debugging
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/development">
                        Development
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/configuration-storage">
                        Configuration Storage
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/building-manual">
                        Building Manual
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/building-in-windows">
                        Building In Windows
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/building-in-ubuntu">
                        Building In Ubuntu
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/building-in-mac-os-x">
                        Building In Mac Os X
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/building-in-eclipse">
                        Building In Eclipse
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/blackbox-internals">
                        Blackbox Internals
                      </a>
                    </li>
                  
                
                  
                    <li>
                      <a href="/docs/development/atomic-barrier">
                        Atomic Barrier
                      </a>
                    </li>
                  
                
              
            </ul>
          
        </div>
      
        <div class="catbloc" id="api">
          
          
            <h3>api</h3>
            <ul class="posts list-unstyled">
              
                
                  
                
              
                
                  
                    <li>
                      <a href="/docs/api/msp_extensions">
                        Msp_extensions
                      </a>
                    </li>
                  
                
              
            </ul>
          
        </div>
      
    </div>
  </div>
</div>
    <footer class="footer text-center">
      <i class="fa fa-copyright"></i> 2015 Cleanflight Team
    </footer>
  </body>
</html>
